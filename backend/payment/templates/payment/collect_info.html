{% extends 'base.html' %}
{% load static %}
{% load crispy_forms_tags %}
{% block content %}
<div class="container">
    <main>
      <div class="text-center">
        <h2>Checkout</h2>
      </div>
      <div class="row g-5">
          <div class="col-md-5 col-lg-4 order-md-last">
                <h4 class="d-flex justify-content-between align-items-center mb-3">
                    <span class="text-primary">Your cart</span>
                    <span class="badge bg-primary rounded-pill">{{ cart|length }}</span>
                </h4>
                <ul class="list-group mb-3">
                    {% for item in cart %}
                        {% with product=item.product %}

                        <li class="list-group-item d-flex justify-content-between lh-sm">
                        <div>
                            <h6 class="my-0">{{ product.title }}</h6>
                            <small class="text-muted">{{ product.composer }}</small>
                        </div>
                        <span class="text-muted">{{ product.cost }}</span>
                        </li>
                        {% endwith %}
                    {% endfor %}
                    <li class="list-group-item d-flex justify-content-between">
                        <span>Total (USD)</span>
                        <strong>{{ cart.get_total_price }}</strong>
                    </li>
                </ul>
                <h4 class="d-flex justify-content-between align-items-center mb-3">Payment</h4>
  
                <!-- Set up a container element for the button -->
                <div id="paypal-button-container"></div>

                <!-- Include the PayPal JavaScript SDK -->
                <script src="https://www.paypal.com/sdk/js?client-id=test&currency=USD"></script>

                <script>
                    // Render the PayPal button into #paypal-button-container
                    paypal.Buttons({
                        style: {
                            color:  'blue',
                            shape:  'pill',
                            label:  'pay',
                            height: 40
                        },
                        // Call your server to set up the transaction
                        createOrder: function(data, actions) {
                            return fetch('/demo/checkout/api/paypal/order/create/', {
                                method: 'post'
                            }).then(function(res) {
                                return res.json();
                            }).then(function(orderData) {
                                return orderData.id;
                            });
                        },
            
                        // Call your server to finalize the transaction
                        onApprove: function(data, actions) {
                            return fetch('/demo/checkout/api/paypal/order/' + data.orderID + '/capture/', {
                                method: 'post'
                            }).then(function(res) {
                                return res.json();
                            }).then(function(orderData) {
                                // Three cases to handle:
                                //   (1) Recoverable INSTRUMENT_DECLINED -> call actions.restart()
                                //   (2) Other non-recoverable errors -> Show a failure message
                                //   (3) Successful transaction -> Show confirmation or thank you
            
                                // This example reads a v2/checkout/orders capture response, propagated from the server
                                // You could use a different API or structure for your 'orderData'
                                var errorDetail = Array.isArray(orderData.details) && orderData.details[0];
            
                                if (errorDetail && errorDetail.issue === 'INSTRUMENT_DECLINED') {
                                    return actions.restart(); // Recoverable state, per:
                                    // https://developer.paypal.com/docs/checkout/integration-features/funding-failure/
                                }
            
                                if (errorDetail) {
                                    var msg = 'Sorry, your transaction could not be processed.';
                                    if (errorDetail.description) msg += '\n\n' + errorDetail.description;
                                    if (orderData.debug_id) msg += ' (' + orderData.debug_id + ')';
                                    return alert(msg); // Show a failure message
                                }
            
                                // Show a success message
                                alert('Transaction completed by ' + orderData.payer.name.given_name);
                            });
                        }
            
                    }).render('#paypal-button-container');
                </script>
            </div>
        <div class="col-md-7 col-lg-8">
          <h4 class="mb-3">Billing Address</h4>
          <form class="needs-validation" novalidate>
            <div class="row g-3">
              <div class="col-sm-6">
                <label for="firstName" class="form-label">First name</label>
                {{ form.first_name|as_crispy_field}}
                <div class="invalid-feedback">
                  Valid first name is required.
                </div>
              </div>
  
              <div class="col-sm-6">
                <label for="lastName" class="form-label">Last name</label>
                {{ form.last_name|as_crispy_field}}
                <div class="invalid-feedback">
                  Valid last name is required.
                </div>
              </div>
  
              <div class="col-12">
                <label for="email" class="form-label">Email</label>
                {{ form.email|as_crispy_field}}
                <div class="invalid-feedback">
                  Please enter a valid email address for shipping updates.
                </div>
              </div>
  
              <div class="col-12">
                <label for="address" class="form-label">Address</label>
                {{ form.address|as_crispy_field}}
                <div class="invalid-feedback">
                  Please enter your shipping address.
                </div>
              </div>
  
              <div class="col-12">
                <label for="address2" class="form-label">City</label>
                {{ form.city|as_crispy_field}}
              </div>
  
              <div class="col-md-4">
                <label for="country" class="form-label">Country</label>
                {{ form.country|as_crispy_field}}
                <div class="invalid-feedback">
                  Please select a valid country.
                </div>
              </div>
  
              <div class="col-md-3">
                <label for="state" class="form-label">State/Province</label>
                {{ form.region|as_crispy_field}}
                <div class="invalid-feedback">
                  Please provide a valid state.
                </div>
              </div>
  
              <div class="col-md-4">
                <label for="zip" class="form-label">Postal Code</label>
                {{ form.postal_code|as_crispy_field}}
                <div class="invalid-feedback">
                  Postal code required.
                </div>
              </div>
            </div>
        </div>
      </div>
    </main>
  </div>
  
  
      <script src="../assets/dist/js/bootstrap.bundle.min.js"></script>
  
      <script src="form-validation.js"></script>
{% endblock %}